name: Build Dh Updater Package

on:
  push:
    branches: [main, master, develop]

permissions:
  contents: write # Ä‘á»ƒ táº¡o/xoÃ¡ tag & release

jobs:
  build-updater:
    runs-on: ubuntu-latest

    env:
      EXE_PATH: ./Dh.Updater.DebugConsole.exe
      ZIP_DIR: ./ # thÆ° má»¥c cáº§n Ä‘Ã³ng gÃ³i
      ZIP_PATH: ./app-update.zip # tÃªn file zip Ä‘áº§u ra
      UPDATER_URLS: "" # náº¿u muá»‘n thÃªm URL ngoÃ i
      EXCLUDE_PATTERNS: "obj/**,bin/Debug/**,*.pdb,.git/**,node_modules/**,.github/**"

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run dh-updater script
        id: updater
        run: |
          node .github/workflows/dh-updater.js "$EXE_PATH" "$ZIP_DIR" "$ZIP_PATH" "$UPDATER_URLS" | tee updater.log
          JSON_LINE=$(grep 'UPDATER_OUTPUT_JSON:' updater.log | sed 's/UPDATER_OUTPUT_JSON://')
          echo "info=$JSON_LINE" >> "$GITHUB_OUTPUT"

      - name: Parse updater info
        id: relvars
        run: |
          INFO='${{ steps.updater.outputs.info }}'
          echo "INFO: $INFO"

          VERSION=$(echo "$INFO"       | jq -r '.version')
          ZIP_PATH=$(echo "$INFO"      | jq -r '.zip_path')
          ZIP_NAME=$(echo "$INFO"      | jq -r '.zip_name')
          JSON_PATH=$(echo "$INFO"     | jq -r '.json_path')
          XML_PATH=$(echo "$INFO"      | jq -r '.xml_path')

          TAG="v$VERSION"
          XML_NAME=$(basename "$XML_PATH")
          JSON_NAME=$(basename "$JSON_PATH")

          ZIP_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${ZIP_NAME}"
          XML_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/tag_release_xml/${XML_NAME}"
          JSON_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/tag_release_json/${JSON_NAME}"

          echo "Version      : $VERSION"
          echo "Tag          : $TAG"
          echo "ZIP path     : $ZIP_PATH"
          echo "XML path     : $XML_PATH"
          echo "JSON path    : $JSON_PATH"
          echo "ZIP URL      : $ZIP_URL"
          echo "XML URL      : $XML_URL"
          echo "JSON URL     : $JSON_URL"

          echo "version=$VERSION"   >> "$GITHUB_OUTPUT"
          echo "tag=$TAG"          >> "$GITHUB_OUTPUT"
          echo "zip_path=$ZIP_PATH" >> "$GITHUB_OUTPUT"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"
          echo "json_path=$JSON_PATH" >> "$GITHUB_OUTPUT"
          echo "xml_path=$XML_PATH"   >> "$GITHUB_OUTPUT"
          echo "xml_name=$XML_NAME"   >> "$GITHUB_OUTPUT"
          echo "json_name=$JSON_NAME" >> "$GITHUB_OUTPUT"
          echo "zip_url=$ZIP_URL"   >> "$GITHUB_OUTPUT"
          echo "xml_url=$XML_URL"   >> "$GITHUB_OUTPUT"
          echo "json_url=$JSON_URL" >> "$GITHUB_OUTPUT"

      # Release 1: CHá»ˆ ZIP theo tag v<version> trÃªn nhÃ¡nh main (xoÃ¡ náº¿u cÃ³, táº¡o láº¡i)
      - name: Publish ZIP release with gh
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG='${{ steps.relvars.outputs.tag }}'
          VERSION='${{ steps.relvars.outputs.version }}'
          ZIP_PATH='${{ steps.relvars.outputs.zip_path }}'
          TITLE="Dh Updater $VERSION"

          echo "ðŸ“¦ Publish release $TAG with asset: $ZIP_PATH"

          # XoÃ¡ release & tag cÅ© náº¿u cÃ³
          gh release view "$TAG" >/dev/null 2>&1 && gh release delete "$TAG" -y || true
          git push origin ":refs/tags/$TAG" || true

          # Táº¡o release má»›i vá»›i ZIP
          gh release create "$TAG" "$ZIP_PATH" \
            --title "$TITLE" \
            --notes "Auto release for version $VERSION" \
            --target "$GITHUB_SHA"

          echo "ZIP release URL:"
          echo "  ${{ steps.relvars.outputs.zip_url }}"

      # Release 2: tag_release_xml vá»›i file XML má»›i nháº¥t (xoÃ¡ cÅ©, táº¡o láº¡i)
      - name: Update XML tagged release (tag_release_xml)
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION='${{ steps.relvars.outputs.version }}'
          XML_PATH='${{ steps.relvars.outputs.xml_path }}'
          XML_NAME='${{ steps.relvars.outputs.xml_name }}'

          TAG_XML="tag_release_xml"
          TITLE_XML="Dh Updater XML latest ($VERSION)"

          echo "ðŸ“ Updating $TAG_XML with $XML_PATH"

          gh release view "$TAG_XML" >/dev/null 2>&1 && gh release delete "$TAG_XML" -y || true
          git push origin ":refs/tags/$TAG_XML" || true

          gh release create "$TAG_XML" "$XML_PATH" \
            --title "$TITLE_XML" \
            --notes "Latest dh.updater.xml for version $VERSION" \
            --target "$GITHUB_SHA"

          echo "XML download URL:"
          echo "  https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG_XML}/${XML_NAME}"

      # Release 3: tag_release_json vá»›i file JSON má»›i nháº¥t (xoÃ¡ cÅ©, táº¡o láº¡i)
      - name: Update JSON tagged release (tag_release_json)
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION='${{ steps.relvars.outputs.version }}'
          JSON_PATH='${{ steps.relvars.outputs.json_path }}'
          JSON_NAME='${{ steps.relvars.outputs.json_name }}'

          TAG_JSON="tag_release_json"
          TITLE_JSON="Dh Updater JSON latest ($VERSION)"

          echo "ðŸ§¾ Updating $TAG_JSON with $JSON_PATH"

          gh release view "$TAG_JSON" >/dev/null 2>&1 && gh release delete "$TAG_JSON" -y || true
          git push origin ":refs/tags/$TAG_JSON" || true

          gh release create "$TAG_JSON" "$JSON_PATH" \
            --title "$TITLE_JSON" \
            --notes "Latest dh.updater.json for version $VERSION" \
            --target "$GITHUB_SHA"

          echo "JSON download URL:"
          echo "  https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG_JSON}/${JSON_NAME}"

      - name: Show updater info
        run: |
          echo "Updater info JSON:"
          echo '${{ steps.updater.outputs.info }}'
          echo ""
          echo "ZIP URL : ${{ steps.relvars.outputs.zip_url }}"
          echo "XML URL : ${{ steps.relvars.outputs.xml_url }}"
          echo "JSON URL: ${{ steps.relvars.outputs.json_url }}"
