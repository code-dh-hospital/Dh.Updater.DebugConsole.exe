name: Build Dh Updater Package

on:
  push:
    branches: [main, master, develop]

permissions:
  contents: write # để push branch & tạo release

jobs:
  build-updater:
    runs-on: ubuntu-latest

    env:
      EXE_PATH: ./Dh.Updater.DebugConsole.exe
      ZIP_DIR: ./ # thư mục cần đóng gói
      ZIP_PATH: ./app-update.zip # tên file zip đầu ra
      UPDATER_URLS: "" # nếu muốn thêm URL ngoài
      EXCLUDE_PATTERNS: "obj/**,bin/Debug/**,*.pdb,.git/**,node_modules/**,.github/**"

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run dh-updater script
        id: updater
        run: |
          node .github/workflows/dh-updater.js "$EXE_PATH" "$ZIP_DIR" "$ZIP_PATH" "$UPDATER_URLS" | tee updater.log
          JSON_LINE=$(grep 'UPDATER_OUTPUT_JSON:' updater.log | sed 's/UPDATER_OUTPUT_JSON://')
          echo "info=$JSON_LINE" >> "$GITHUB_OUTPUT"

      - name: Parse updater info
        id: relvars
        run: |
          INFO='${{ steps.updater.outputs.info }}'
          echo "INFO: $INFO"

          VERSION=$(echo "$INFO" | jq -r '.version')
          ZIP_PATH=$(echo "$INFO" | jq -r '.zip_path')
          ZIP_NAME=$(echo "$INFO" | jq -r '.zip_name')
          JSON_PATH=$(echo "$INFO" | jq -r '.json_path')
          XML_PATH=$(echo "$INFO" | jq -r '.xml_path')

          TAG="v$VERSION"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "zip_path=$ZIP_PATH" >> "$GITHUB_OUTPUT"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"
          echo "json_path=$JSON_PATH" >> "$GITHUB_OUTPUT"
          echo "xml_path=$XML_PATH" >> "$GITHUB_OUTPUT"

            # Release 1: ZIP theo tag v<version> trên nhánh main
      - name: Create GitHub Release (zip)
        if: github.ref == 'refs/heads/main'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.relvars.outputs.tag }}
          release_name: Dh Updater ${{ steps.relvars.outputs.version }}
          draft: false
          prerelease: false
          target_commitish: ${{ github.sha }}

      - name: Upload ZIP asset
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.relvars.outputs.zip_path }}
          asset_name: ${{ steps.relvars.outputs.zip_name }}
          asset_content_type: application/zip

      # Release 2: tag_release_xml với file XML mới nhất
      - name: Update XML tagged release
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          INFO='${{ steps.updater.outputs.info }}'
          VERSION=$(echo "$INFO" | jq -r '.version')
          XML_PATH=$(echo "$INFO" | jq -r '.xml_path')

          TAG_XML="tag_release_xml"
          TITLE_XML="Dh Updater XML latest ($VERSION)"

          echo "Updating release $TAG_XML with $XML_PATH"

          # Xoá release cũ (nếu có), bỏ qua lỗi nếu chưa tồn tại
          gh release delete "$TAG_XML" -y || true

          # Tạo release mới với tag cố định, file XML mới nhất
          gh release create "$TAG_XML" "$XML_PATH" \
            --title "$TITLE_XML" \
            --notes "Latest dh.updater.xml for version $VERSION" \
            --target "${GITHUB_SHA}"

      # Release 3: tag_release_json với file JSON mới nhất
      - name: Update JSON tagged release
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          INFO='${{ steps.updater.outputs.info }}'
          VERSION=$(echo "$INFO" | jq -r '.version')
          JSON_PATH=$(echo "$INFO" | jq -r '.json_path')

          TAG_JSON="tag_release_json"
          TITLE_JSON="Dh Updater JSON latest ($VERSION)"

          echo "Updating release $TAG_JSON with $JSON_PATH"

          gh release delete "$TAG_JSON" -y || true

          gh release create "$TAG_JSON" "$JSON_PATH" \
            --title "$TITLE_JSON" \
            --notes "Latest dh.updater.json for version $VERSION" \
            --target "${GITHUB_SHA}"

      - name: Show updater info
        run: |
          echo "Updater info JSON:"
          echo '${{ steps.updater.outputs.info }}'
