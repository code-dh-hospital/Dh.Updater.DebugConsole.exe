name: Build Dh Updater Package

on:
  push:
    branches: [main, master, develop]

permissions:
  contents: write # để push branch & tạo release

jobs:
  build-updater:
    runs-on: ubuntu-latest

    env:
      EXE_PATH: ./Dh.Updater.DebugConsole.exe
      ZIP_DIR: ./ # thư mục cần đóng gói
      ZIP_PATH: ./app-update.zip # tên file zip đầu ra
      UPDATER_URLS: "" # nếu muốn thêm URL ngoài
      EXCLUDE_PATTERNS: "obj/**,bin/Debug/**,*.pdb,.git/**,node_modules/**,.github/**"

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run dh-updater script
        id: updater
        run: |
          node .github/workflows/dh-updater.js "$EXE_PATH" "$ZIP_DIR" "$ZIP_PATH" "$UPDATER_URLS" | tee updater.log
          JSON_LINE=$(grep 'UPDATER_OUTPUT_JSON:' updater.log | sed 's/UPDATER_OUTPUT_JSON://')
          echo "info=$JSON_LINE" >> "$GITHUB_OUTPUT"

      - name: Parse updater info
        id: relvars
        run: |
          INFO='${{ steps.updater.outputs.info }}'
          echo "INFO: $INFO"

          VERSION=$(echo "$INFO" | jq -r '.version')
          ZIP_PATH=$(echo "$INFO" | jq -r '.zip_path')
          ZIP_NAME=$(echo "$INFO" | jq -r '.zip_name')
          JSON_PATH=$(echo "$INFO" | jq -r '.json_path')
          XML_PATH=$(echo "$INFO" | jq -r '.xml_path')

          TAG="v$VERSION"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "zip_path=$ZIP_PATH" >> "$GITHUB_OUTPUT"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"
          echo "json_path=$JSON_PATH" >> "$GITHUB_OUTPUT"
          echo "xml_path=$XML_PATH" >> "$GITHUB_OUTPUT"

            # Release 1: ZIP + XML + JSON theo tag v<version> trên nhánh main
      - name: Create GitHub Release (main)
        if: github.ref == 'refs/heads/main'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.relvars.outputs.tag }}
          release_name: Dh Updater ${{ steps.relvars.outputs.version }}
          draft: false # public
          prerelease: false # để được tính là "latest"
          target_commitish: ${{ github.sha }}

      - name: Upload ZIP asset
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.relvars.outputs.zip_path }}
          asset_name: ${{ steps.relvars.outputs.zip_name }}
          asset_content_type: application/zip

      - name: Upload XML asset to main release
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.relvars.outputs.xml_path }}
          asset_name: Dh.Updater.DebugConsole.exe.dh.updater.xml
          asset_content_type: application/xml

      - name: Upload JSON asset to main release
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.relvars.outputs.json_path }}
          asset_name: Dh.Updater.DebugConsole.exe.dh.updater.json
          asset_content_type: application/json
