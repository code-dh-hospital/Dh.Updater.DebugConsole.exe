name: Build Dh Updater Package

on:
  push:
    branches: [main, master, develop]

permissions:
  contents: write # ƒë·ªÉ t·∫°o/xo√° tag & release

jobs:
  build-updater:
    runs-on: ubuntu-latest

    env:
      EXE_PATH: ./Dh.Updater.DebugConsole.exe
      ZIP_DIR: ./ # th∆∞ m·ª•c c·∫ßn ƒë√≥ng g√≥i
      ZIP_PATH: ./app-update.zip # tham s·ªë, script s·∫Ω override t√™n theo version
      UPDATER_URLS: "" # n·∫øu mu·ªën th√™m URL ngo√†i
      EXCLUDE_PATTERNS: "obj/**,bin/Debug/**,*.pdb,.git/**,node_modules/**,.github/**,.github/*"

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install jq and zip
        run: |
          sudo apt-get update
          sudo apt-get install -y jq zip

      - name: Run dh-updater script
        id: updater
        run: |
          node .github/workflows/dh-updater.js "$EXE_PATH" "$ZIP_DIR" "$ZIP_PATH" "$UPDATER_URLS" | tee /tmp/updater.log
          JSON_LINE=$(grep 'UPDATER_OUTPUT_JSON:' /tmp/updater.log | sed 's/UPDATER_OUTPUT_JSON://')
          echo "info=$JSON_LINE" >> "$GITHUB_OUTPUT"

      - name: Parse updater info
        id: relvars
        run: |
          INFO='${{ steps.updater.outputs.info }}'
          echo "INFO: $INFO"

          VERSION=$(echo "$INFO"   | jq -r '.version')
          ZIP_PATH=$(echo "$INFO"  | jq -r '.zip_path')
          ZIP_NAME=$(echo "$INFO"  | jq -r '.zip_name')
          JSON_PATH=$(echo "$INFO" | jq -r '.json_path')
          XML_PATH=$(echo "$INFO"  | jq -r '.xml_path')

          TAG="v$VERSION"
          XML_NAME=$(basename "$XML_PATH")
          JSON_NAME=$(basename "$JSON_PATH")

          ZIP_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${ZIP_NAME}"
          XML_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/tag_release_xml/${XML_NAME}"
          JSON_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/tag_release_json/${JSON_NAME}"

          echo "version=$VERSION"      >> "$GITHUB_OUTPUT"
          echo "tag=$TAG"             >> "$GITHUB_OUTPUT"
          echo "zip_path=$ZIP_PATH"   >> "$GITHUB_OUTPUT"
          echo "zip_name=$ZIP_NAME"   >> "$GITHUB_OUTPUT"
          echo "json_path=$JSON_PATH" >> "$GITHUB_OUTPUT"
          echo "xml_path=$XML_PATH"   >> "$GITHUB_OUTPUT"
          echo "xml_name=$XML_NAME"   >> "$GITHUB_OUTPUT"
          echo "json_name=$JSON_NAME" >> "$GITHUB_OUTPUT"
          echo "zip_url=$ZIP_URL"     >> "$GITHUB_OUTPUT"
          echo "xml_url=$XML_URL"     >> "$GITHUB_OUTPUT"
          echo "json_url=$JSON_URL"   >> "$GITHUB_OUTPUT"

      # Release 1: CH·ªà ZIP theo tag v<version> tr√™n nh√°nh main (xo√° n·∫øu c√≥, t·∫°o l·∫°i)
      - name: Publish ZIP release with gh
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUSHER: ${{ github.actor }}
          PUSH_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          TAG='${{ steps.relvars.outputs.tag }}'
          VERSION='${{ steps.relvars.outputs.version }}'
          ZIP_PATH='${{ steps.relvars.outputs.zip_path }}'
          ZIP_NAME='${{ steps.relvars.outputs.zip_name }}'
          TITLE="$ZIP_NAME"

          echo "üì¶ Publish release $TAG with asset: $ZIP_PATH"

          # Xo√° release & tag c≈© n·∫øu c√≥ (ƒë·∫£m b·∫£o t·∫°o m·ªõi clean)
          gh release view "$TAG" >/dev/null 2>&1 && gh release delete "$TAG" -y || true
          git push origin ":refs/tags/$TAG" || true

          BODY=$'Latest zip for version '"$VERSION"$'\n\nPushed by: '"$PUSHER"$'\nCommit message:\n'"$PUSH_MESSAGE"

          gh release create "$TAG" "$ZIP_PATH" \
            --title "$TITLE" \
            --notes "$BODY" \
            --target "$GITHUB_SHA"

          echo "ZIP release URL:"
          echo "  ${{ steps.relvars.outputs.zip_url }}"

      # Release 2: tag_release_xml v·ªõi file XML m·ªõi nh·∫•t (xo√° c≈©, t·∫°o l·∫°i)
      - name: Update XML tagged release (tag_release_xml)
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUSHER: ${{ github.actor }}
          PUSH_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          VERSION='${{ steps.relvars.outputs.version }}'
          XML_PATH='${{ steps.relvars.outputs.xml_path }}'
          XML_NAME='${{ steps.relvars.outputs.xml_name }}'
          ZIP_NAME='${{ steps.relvars.outputs.zip_name }}'

          TAG_XML="tag_release_xml"

          TITLE_XML="$ZIP_NAME"

          echo "üìù Updating $TAG_XML with $XML_PATH"

          gh release view "$TAG_XML" >/dev/null 2>&1 && gh release delete "$TAG_XML" -y || true
          git push origin ":refs/tags/$TAG_XML" || true

          BODY=$'Latest dh.updater.xml for version '"$VERSION"$'\n\nPushed by: '"$PUSHER"$'\nCommit message:\n'"$PUSH_MESSAGE"

          gh release create "$TAG_XML" "$XML_PATH" \
            --title "$TITLE_XML" \
            --notes "$BODY" \
            --target "$GITHUB_SHA"

          echo "XML download URL:"
          echo "  https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG_XML}/${XML_NAME}"

      # Release 3: tag_release_json v·ªõi file JSON m·ªõi nh·∫•t (xo√° c≈©, t·∫°o l·∫°i)
      - name: Update JSON tagged release (tag_release_json)
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUSHER: ${{ github.actor }}
          PUSH_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          VERSION='${{ steps.relvars.outputs.version }}'
          JSON_PATH='${{ steps.relvars.outputs.json_path }}'
          JSON_NAME='${{ steps.relvars.outputs.json_name }}'
          ZIP_NAME='${{ steps.relvars.outputs.zip_name }}'

          TAG_JSON="tag_release_json"
          TITLE_JSON="$ZIP_NAME"

          echo "üßæ Updating $TAG_JSON with $JSON_PATH"

          gh release view "$TAG_JSON" >/dev/null 2>&1 && gh release delete "$TAG_JSON" -y || true
          git push origin ":refs/tags/$TAG_JSON" || true

          BODY=$'Latest dh.updater.json for version '"$VERSION"$'\n\nPushed by: '"$PUSHER"$'\nCommit message:\n'"$PUSH_MESSAGE"

          gh release create "$TAG_JSON" "$JSON_PATH" \
            --title "$TITLE_JSON" \
            --notes "$BODY" \
            --target "$GITHUB_SHA"

          echo "JSON download URL:"
          echo "  https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG_JSON}/${JSON_NAME}"

      # Ch·ªâ gi·ªØ l·∫°i 5 release ZIP g·∫ßn nh·∫•t (tag b·∫Øt ƒë·∫ßu b·∫±ng v)
      - name: Cleanup old ZIP releases (keep last 5)
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG='${{ steps.relvars.outputs.tag }}'
          KEEP=5

          echo "üßπ Cleaning old ZIP releases (keep last $KEEP)..."

          # List releases (newest first), filter tag b·∫Øt ƒë·∫ßu b·∫±ng v
          TAGS=$(gh release list --limit 100 --exclude-drafts --exclude-pre-releases | awk '{print $1}' | grep '^v' || true)

          i=0
          for t in $TAGS; do
            i=$((i+1))

            # gi·ªØ l·∫°i 5 tag ƒë·∫ßu ti√™n (m·ªõi nh·∫•t)
            if [ $i -le $KEEP ]; then
              continue
            fi

            # ƒë·ªÅ ph√≤ng: n·∫øu l·ª° tr√πng current_tag th√¨ skip
            if [ "$t" = "$CURRENT_TAG" ]; then
              continue
            fi

            echo "üîª Deleting old release $t"
            gh release delete "$t" -y || true
            git push origin ":refs/tags/$t" || true
          done

      - name: Show updater info
        run: |
          echo "Updater info JSON:"
          echo '${{ steps.updater.outputs.info }}'
          echo ""
          echo "ZIP URL : ${{ steps.relvars.outputs.zip_url }}"
          echo "XML URL : ${{ steps.relvars.outputs.xml_url }}"
          echo "JSON URL: ${{ steps.relvars.outputs.json_url }}"
