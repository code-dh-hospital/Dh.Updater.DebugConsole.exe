# .github/workflows/read-fileversion.yml
name: Read FileVersion on Push

on:
  push:
    branches:
      - main
      - master
      - develop

jobs:
  get-file-version:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout source
        uses: actions/checkout@v4

      # Chá»‰nh Ä‘Æ°á»ng dáº«n file EXE/DLL á»Ÿ Ä‘Ã¢y â†“â†“â†“
      - name: ðŸ”§ Set EXE path
        run: echo "EXE_PATH=bin/Release/net8.0/MyApp.exe" >> $GITHUB_ENV

      - name: ðŸ” Extract FileVersion
        id: fileversion
        run: |
          FILE="$EXE_PATH"

          echo "ðŸ“Œ File: $FILE"

          if [ ! -f "$FILE" ]; then
            echo "âŒ File khÃ´ng tá»“n táº¡i. Kiá»ƒm tra láº¡i Ä‘Æ°á»ng dáº«n."
            exit 1
          fi

          # TÃ¬m cÃ¡c dÃ²ng chá»©a thÃ´ng tin version
          RAW=$(strings "$FILE" | grep -E "FileVersion|ProductVersion|AssemblyFileVersion" || true)

          echo "ðŸ”Ž Raw version lines:"
          echo "$RAW"

          # Láº¥y chuá»—i dáº¡ng x.x.x.x tá»« raw data
          VERSION=$(echo "$RAW" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | head -n1)

          # Fallback quÃ©t toÃ n file
          if [ -z "$VERSION" ]; then
            VERSION=$(strings "$FILE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | head -n1)
          fi

          if [ -z "$VERSION" ]; then
            echo "âŒ KhÃ´ng tÃ¬m Ä‘Æ°á»£c FileVersion."
            exit 1
          fi

          echo "âœ… Detected FileVersion: $VERSION"
          echo "file_version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: ðŸ“£ Log version
        run: echo "FileVersion lÃ : ${{ steps.fileversion.outputs.file_version }}"
